{% extends "base.html" %}

{% block title %}Entrenar Modelo - ML Hardware Prediction{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-12">
        <h2><i class="fas fa-dumbbell text-primary"></i> GUI 1: Entrenar Modelos</h2>
        <p class="text-muted">Carga un archivo CSV y entrena tu modelo de Machine Learning</p>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-cog"></i> Configuración de Entrenamiento</h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="trainForm">
                    <!-- Carga de archivo CSV -->
                    <div class="form-section">
                        <h6><i class="fas fa-file-csv"></i> 1. Cargar Archivo CSV</h6>
                        <div class="mb-3">
                            <label for="csv_file" class="form-label">Selecciona el archivo CSV:</label>
                            <input type="file" class="form-control" id="csv_file" name="csv_file" accept=".csv" required>
                            <div class="form-text">El archivo debe contener las columnas de características y la columna objetivo.</div>
                        </div>
                    </div>

                    <!-- Selección de modelo -->
                    <div class="form-section">
                        <h6><i class="fas fa-brain"></i> 2. Seleccionar Modelo</h6>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="model_type" id="id3" value="id3" required>
                                <label class="form-check-label" for="id3">
                                    <strong>ID3 (Árbol de Decisión)</strong> - Ideal para datos categóricos
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="model_type" id="knn" value="knn" required>
                                <label class="form-check-label" for="knn">
                                    <strong>KNN (K-Vecinos Más Cercanos)</strong> - Efectivo para patrones locales
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Parámetros específicos de KNN -->
                    <div class="form-section" id="knn_params" style="display: none;">
                        <h6><i class="fas fa-sliders-h"></i> Parámetros KNN</h6>
                        <div class="mb-3">
                            <label for="n_neighbors" class="form-label">Número de vecinos (K):</label>
                            <input type="number" class="form-control" id="n_neighbors" name="n_neighbors" value="5" min="1" max="50">
                        </div>
                    </div>

                    <!-- Método de validación -->
                    <div class="form-section">
                        <h6><i class="fas fa-chart-line"></i> 3. Método de Validación</h6>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="validation_method" id="holdout" value="holdout" required>
                                <label class="form-check-label" for="holdout">
                                    <strong>Hold-out</strong> - División simple entrenamiento/prueba
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="validation_method" id="kfold" value="kfold" required>
                                <label class="form-check-label" for="kfold">
                                    <strong>K-Fold Cross Validation</strong> - Validación cruzada
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Parámetros de Hold-out -->
                    <div class="form-section" id="holdout_params" style="display: none;">
                        <h6><i class="fas fa-percentage"></i> Parámetros Hold-out</h6>
                        <div class="mb-3">
                            <label for="test_size" class="form-label">Tamaño del conjunto de prueba (0.1 - 0.5):</label>
                            <input type="number" class="form-control" id="test_size" name="test_size" value="0.3" min="0.1" max="0.5" step="0.1">
                        </div>
                    </div>

                    <!-- Parámetros de K-Fold -->
                    <div class="form-section" id="kfold_params" style="display: none;">
                        <h6><i class="fas fa-layer-group"></i> Parámetros K-Fold</h6>
                        <div class="mb-3">
                            <label for="k_folds" class="form-label">Número de folds (K):</label>
                            <input type="number" class="form-control" id="k_folds" name="k_folds" value="5" min="3" max="10">
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-play"></i> Entrenar Modelo
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-info-circle"></i> Información</h6>
            </div>
            <div class="card-body">
                <h6>Formatos de archivo:</h6>
                <ul>
                    <li>Solo archivos CSV</li>
                    <li>La última columna debe ser el objetivo</li>
                    <li>Sin valores faltantes</li>
                </ul>
                
                <h6>Modelos disponibles:</h6>
                <ul>
                    <li><strong>ID3:</strong> Árbol de decisión basado en entropía</li>
                    <li><strong>KNN:</strong> Clasificación por vecinos cercanos</li>
                </ul>
                
                <h6>Métodos de validación:</h6>
                <ul>
                    <li><strong>Hold-out:</strong> Rápido, menos robusto</li>
                    <li><strong>K-Fold:</strong> Más robusto, toma más tiempo</li>
                </ul>
            </div>
        </div>
    </div>
</div>

{% if results %}
<div class="row mt-4">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-chart-bar"></i> Resultados del Entrenamiento</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Información del modelo -->
                    <div class="col-md-4">
                        <h6><i class="fas fa-info-circle"></i> Información del Modelo:</h6>
                        <ul class="list-unstyled">
                            <li><strong>Tipo:</strong> {{ results.model_type }}</li>
                            <li><strong>Método:</strong> {{ results.method }}</li>
                            {% if results.n_neighbors %}
                                <li><strong>Vecinos (K):</strong> {{ results.n_neighbors }}</li>
                            {% endif %}
                            {% if results.test_size %}
                                <li><strong>Tamaño de prueba:</strong> {{ "%.1f%%" | format(results.test_size * 100) }}</li>
                            {% endif %}
                            {% if results.k_folds %}
                                <li><strong>Número de folds:</strong> {{ results.k_folds }}</li>
                            {% endif %}
                            <li><strong>Clases únicas:</strong> {{ results.num_classes }}</li>
                            {% if results.avg_method %}
                                <li><strong>Método de promedio:</strong> {{ results.avg_method }}</li>
                            {% endif %}
                        </ul>
                    </div>
                    
                    <!-- Métricas principales -->
                    <div class="col-md-4">
                        <h6><i class="fas fa-chart-line"></i> Métricas de Rendimiento:</h6>
                        <div class="row text-center">
                            <!-- Accuracy -->
                            <div class="col-12 mb-2">
                                <div class="card bg-primary text-white">
                                    <div class="card-body p-2">
                                        <h6 class="card-title mb-1">Accuracy</h6>
                                        <h4 class="mb-1">{{ "%.4f" | format(results.accuracy) }}</h4>
                                        <small>{{ "%.2f%%" | format(results.accuracy * 100) }}</small>
                                        {% if results.accuracy_std %}
                                            <br><small>±{{ "%.4f" | format(results.accuracy_std) }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Precision -->
                            <div class="col-12 mb-2">
                                <div class="card bg-info text-white">
                                    <div class="card-body p-2">
                                        <h6 class="card-title mb-1">Precision</h6>
                                        <h4 class="mb-1">{{ "%.4f" | format(results.precision) }}</h4>
                                        <small>{{ "%.2f%%" | format(results.precision * 100) }}</small>
                                        {% if results.precision_std %}
                                            <br><small>±{{ "%.4f" | format(results.precision_std) }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Recall -->
                            <div class="col-12 mb-2">
                                <div class="card bg-warning text-white">
                                    <div class="card-body p-2">
                                        <h6 class="card-title mb-1">Recall</h6>
                                        <h4 class="mb-1">{{ "%.4f" | format(results.recall) }}</h4>
                                        <small>{{ "%.2f%%" | format(results.recall * 100) }}</small>
                                        {% if results.recall_std %}
                                            <br><small>±{{ "%.4f" | format(results.recall_std) }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- F1-Score -->
                            <div class="col-12 mb-2">
                                <div class="card bg-success text-white">
                                    <div class="card-body p-2">
                                        <h6 class="card-title mb-1">F1-Score</h6>
                                        <h4 class="mb-1">{{ "%.4f" | format(results.f1_score) }}</h4>
                                        <small>{{ "%.2f%%" | format(results.f1_score * 100) }}</small>
                                        {% if results.f1_score_std %}
                                            <br><small>±{{ "%.4f" | format(results.f1_score_std) }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detalles adicionales -->
                    <div class="col-md-4">
                        {% if results.cv_scores %}
                            <h6><i class="fas fa-layer-group"></i> Scores por Fold:</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Fold</th>
                                            <th>Acc</th>
                                            <th>Prec</th>
                                            <th>Rec</th>
                                            <th>F1</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for i in range(results.cv_scores.accuracy|length) %}
                                        <tr>
                                            <td>{{ i + 1 }}</td>
                                            <td>{{ "%.3f" | format(results.cv_scores.accuracy[i]) }}</td>
                                            <td>{{ "%.3f" | format(results.cv_scores.precision[i]) }}</td>
                                            <td>{{ "%.3f" | format(results.cv_scores.recall[i]) }}</td>
                                            <td>{{ "%.3f" | format(results.cv_scores.f1[i]) }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% endif %}
                        
                        {% if results.classification_report %}
                            <h6><i class="fas fa-clipboard-list"></i> Resumen por Clase:</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Clase</th>
                                            <th>Prec</th>
                                            <th>Rec</th>
                                            <th>F1</th>
                                            <th>Sup</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for class_name, metrics in results.classification_report.items() %}
                                            {% if class_name not in ['accuracy', 'macro avg', 'weighted avg'] and metrics is mapping %}
                                            <tr>
                                                <td>{{ class_name }}</td>
                                                <td>{{ "%.3f" | format(metrics.precision) }}</td>
                                                <td>{{ "%.3f" | format(metrics.recall) }}</td>
                                                <td>{{ "%.3f" | format(metrics['f1-score']) }}</td>
                                                <td>{{ metrics.support }}</td>
                                            </tr>
                                            {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% endif %}
                        
                        <!-- Interpretación de métricas -->
                        <div class="alert alert-info mt-3">
                            <h6 class="alert-heading"><i class="fas fa-lightbulb"></i> Interpretación:</h6>
                            <ul class="small mb-0">
                                <li><strong>Accuracy:</strong> % de predicciones correctas</li>
                                <li><strong>Precision:</strong> % de predicciones positivas correctas</li>
                                <li><strong>Recall:</strong> % de casos positivos detectados</li>
                                <li><strong>F1-Score:</strong> Media armónica entre precision y recall</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Mostrar/ocultar parámetros según el modelo seleccionado
    const id3Radio = document.getElementById('id3');
    const knnRadio = document.getElementById('knn');
    const knnParams = document.getElementById('knn_params');
    
    function toggleKnnParams() {
        if (knnRadio.checked) {
            knnParams.style.display = 'block';
        } else {
            knnParams.style.display = 'none';
        }
    }
    
    id3Radio.addEventListener('change', toggleKnnParams);
    knnRadio.addEventListener('change', toggleKnnParams);
    
    // Mostrar/ocultar parámetros según el método de validación
    const holdoutRadio = document.getElementById('holdout');
    const kfoldRadio = document.getElementById('kfold');
    const holdoutParams = document.getElementById('holdout_params');
    const kfoldParams = document.getElementById('kfold_params');
    
    function toggleValidationParams() {
        if (holdoutRadio.checked) {
            holdoutParams.style.display = 'block';
            kfoldParams.style.display = 'none';
        } else if (kfoldRadio.checked) {
            holdoutParams.style.display = 'none';
            kfoldParams.style.display = 'block';
        } else {
            holdoutParams.style.display = 'none';
            kfoldParams.style.display = 'none';
        }
    }
    
    holdoutRadio.addEventListener('change', toggleValidationParams);
    kfoldRadio.addEventListener('change', toggleValidationParams);
});
</script>
{% endblock %}